<link rel="import" href="bower_components/polymer/polymer.html">

<!--
This element allows you to lazy load images as you scroll

Example:

    <img is='lazy-img' src='path/to/image.png'/>

@group Seed Elements
@element lazy-img
@demo demo/index.html

-->
<dom-module id="lazy-img">

  <template>
    <content></content>
  </template>

</dom-module>

<script>

  var inViewport = function(el) {
    var rect   = el.getBoundingClientRect();
    var top    = document.documentElement.scrollTop;
    var bottom = document.documentElement.clientHeight;
    // If the image is in the viewport
    if ((rect.bottom > top && rect.bottom < bottom) ||
           (rect.top > top && rect.bottom < bottom) ||
           (rect.top > top && rect.top < bottom )) {
      return true;
    }
    return false;
  };

  Polymer({

    is: 'lazy-img',

    extends: 'img',

    properties: {
      /**
       * The path to the image.
       */
       src: String,
    },

    // Element Lifecycle

    created: function() {

      // Create an empty image
      fallbackImage = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAEElEQVR42gEFAPr/AP///wAI/AL+Sr4t6gAAAABJRU5ErkJggg==";

      // swap original src attribute
      this.original = this.src;
      this.src = fallbackImage;
    },

    ready: function() {
      this.onerror = function() {
        if (this.src !== this.original) this._clearScroll();
      }.bind(this);
    },

    attached: function() {
      // Our default listener task (for sanity's sake)
      this.listener = function() { /* noop */ };
      
      // Check if Element is in viewport      
      if (inViewport(this)) {
        // Set src if it is valid
        this.src = this.original;
      } else {
        // Register scroll listener if it is not
        this.listener = this._handleScroll.bind(this);
        document.addEventListener('scroll', this.listener);
      }
    },

    detached: function() {
      if (this.src !== this.original) this._clearScroll();
    },
    _handleScroll: function(e) {
      this.debounce('lazy-img-check', function() {
        if (inViewport(this)) {
          this.src = this.original;
          this._clearScroll();
        }
      }.bind(this));
    },
    _clearScroll: function() {
      document.removeEventListener('scroll', this.listener);
    }
  });

</script>
